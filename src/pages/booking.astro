---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Image from '~/components/common/Image.astro';

const metadata = {
  title: 'Book Window Cleaning Online - Somerset Window Cleaning | Instant Quote & Setup',
  description: 'Book professional window cleaning in Somerset online. Get instant pricing, choose your services, and set up Direct Debit in minutes. Transparent pricing with no hidden fees.',
};
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <Hero>
    <Fragment slot="title">
      Book Your Window Cleaning <span class="text-accent">Online</span>
    </Fragment>
    <Fragment slot="subtitle">
      Get instant pricing, choose your services, and book your regular window cleaning service in minutes.
    </Fragment>
    <Fragment slot="bg">
      <Image src="~/assets/images/solar-panels.jpeg" alt="" width={1600} height={900} layout="cover" style="width:100%; height:100%; object-fit:cover; opacity:0.35;" />
      <div class="absolute inset-0 bg-black/40"></div>
    </Fragment>
  </Hero>

  <!-- Booking System -->
  <WidgetWrapper>
    <div class="max-w-7xl mx-auto px-4 py-12">
      
      <!-- Progress Indicator -->
      <div class="mb-12">
        <div class="flex items-center justify-center space-x-4 mb-6">
          <div class="flex items-center">
            <div id="step-1-indicator" class="w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
            <span class="ml-2 text-sm font-medium">Property & Services</span>
          </div>
          <div class="w-8 h-1 bg-gray-200">
            <div id="progress-1" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
          </div>
          <div class="flex items-center">
            <div id="step-2-indicator" class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-bold">2</div>
            <span class="ml-2 text-sm font-medium text-gray-500">Your Details</span>
          </div>
          <div class="w-8 h-1 bg-gray-200">
            <div id="progress-2" class="h-full bg-primary transition-all duration-300" style="width: 0%"></div>
          </div>
          <div class="flex items-center">
            <div id="step-3-indicator" class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-bold">3</div>
            <span class="ml-2 text-sm font-medium text-gray-500">Schedule & Payment</span>
          </div>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Booking Form -->
        <div class="lg:col-span-2 space-y-8">
          
          <!-- Step 1: Property & Services -->
          <div id="step-1" class="bg-white rounded-xl shadow-lg border border-gray-100 p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 1: Property & Services</h2>
            
            <!-- Property Type -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-4">Property Type</label>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button type="button" class="property-type-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center hover:border-primary hover:bg-primary/5 transition-all group" data-type="house">
                  <div class="text-3xl mb-2">🏠</div>
                  <div class="font-medium group-hover:text-primary">House</div>
                </button>
                <button type="button" class="property-type-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center hover:border-primary hover:bg-primary/5 transition-all group" data-type="flat">
                  <div class="text-3xl mb-2">🏢</div>
                  <div class="font-medium group-hover:text-primary">Flat/Apartment</div>
                </button>
                <button type="button" class="property-type-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center hover:border-primary hover:bg-primary/5 transition-all group" data-type="commercial">
                  <div class="text-3xl mb-2">🏪</div>
                  <div class="font-medium group-hover:text-primary">Commercial</div>
                </button>
                <button type="button" class="property-type-btn bg-white border-2 border-gray-200 rounded-xl p-4 text-center hover:border-primary hover:bg-primary/5 transition-all group" data-type="other">
                  <div class="text-3xl mb-2">🏗️</div>
                  <div class="font-medium group-hover:text-primary">Other</div>
                </button>
              </div>
            </div>

            <!-- Number of Bedrooms -->
            <div id="bedrooms-section" class="mb-8 hidden">
              <label class="block text-sm font-medium text-gray-700 mb-3">Number of Bedrooms</label>
              <select id="bedrooms" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white">
                <option value="">Select bedrooms</option>
                <option value="1">1 bedroom</option>
                <option value="2">2 bedrooms</option>
                <option value="3">3 bedrooms</option>
                <option value="4">4 bedrooms</option>
                <option value="5">5+ bedrooms</option>
              </select>
            </div>

            <!-- Services Selection -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-4">Services Required</label>
              <div class="grid md:grid-cols-2 gap-4">
                
                <!-- Window Cleaning -->
                <div class="service-option border-2 border-gray-200 rounded-lg p-4 transition-all hover:border-primary/50">
                  <label class="flex items-start cursor-pointer">
                    <input type="checkbox" name="services" value="windows" checked class="service-checkbox mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                    <div class="ml-3 flex-1">
                      <div class="font-medium text-gray-900">Window Cleaning</div>
                      <div class="text-sm text-gray-600 mt-1">Inside & outside, frames and sills included</div>
                      <div class="text-sm font-semibold text-primary mt-1" id="windows-price">£15-£55</div>
                    </div>
                  </label>
                </div>

                <!-- Gutter Clearing -->
                <div class="service-option border-2 border-gray-200 rounded-lg p-4 transition-all hover:border-primary/50">
                  <label class="flex items-start cursor-pointer">
                    <input type="checkbox" name="services" value="gutters" class="service-checkbox mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                    <div class="ml-3 flex-1">
                      <div class="font-medium text-gray-900">Gutter Clearing</div>
                      <div class="text-sm text-gray-600 mt-1">High-reach vacuum system, photo report</div>
                      <div class="text-sm font-semibold text-primary mt-1" id="gutters-price">+£25-£70</div>
                    </div>
                  </label>
                </div>

                <!-- Fascia & Soffit -->
                <div class="service-option border-2 border-gray-200 rounded-lg p-4 transition-all hover:border-primary/50">
                  <label class="flex items-start cursor-pointer">
                    <input type="checkbox" name="services" value="fascia" class="service-checkbox mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                    <div class="ml-3 flex-1">
                      <div class="font-medium text-gray-900">Fascia & Soffit</div>
                      <div class="text-sm text-gray-600 mt-1">UPVC cleaning, removes algae and grime</div>
                      <div class="text-sm font-semibold text-primary mt-1" id="fascia-price">+£20-£80</div>
                    </div>
                  </label>
                </div>

                <!-- Conservatory Roof -->
                <div class="service-option border-2 border-gray-200 rounded-lg p-4 transition-all hover:border-primary/50">
                  <label class="flex items-start cursor-pointer">
                    <input type="checkbox" name="services" value="conservatory" class="service-checkbox mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                    <div class="ml-3 flex-1">
                      <div class="font-medium text-gray-900">Conservatory Roof</div>
                      <div class="text-sm text-gray-600 mt-1">Panels and frames, algae removal</div>
                      <div class="text-sm font-semibold text-primary mt-1" id="conservatory-price">+£30-£100</div>
                    </div>
                  </label>
                </div>

                <!-- Solar Panel Cleaning -->
                <div class="service-option border-2 border-gray-200 rounded-lg p-4 transition-all hover:border-primary/50">
                  <label class="flex items-start cursor-pointer">
                    <input type="checkbox" name="services" value="solar" class="service-checkbox mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                    <div class="ml-3 flex-1">
                      <div class="font-medium text-gray-900">Solar Panel Cleaning</div>
                      <div class="text-sm text-gray-600 mt-1">Maintain efficiency and warranties</div>
                      <div class="text-sm font-semibold text-primary mt-1" id="solar-price">+£60-£150</div>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <!-- Frequency -->
            <div class="mb-8">
              <label class="block text-sm font-medium text-gray-700 mb-3">Cleaning Frequency</label>
              <select id="frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white">
                <option value="4">Every 4 weeks - 10% discount (Most Popular)</option>
                <option value="6">Every 6 weeks - 5% discount</option>
                <option value="8">Every 8 weeks - Standard rate</option>
                <option value="12">Every 12 weeks - 10% premium</option>
                <option value="one-off">One-off clean - 20% premium</option>
              </select>
            </div>

            <!-- Postcode -->
            <div class="mb-6">
              <label for="postcode" class="block text-sm font-medium text-gray-700 mb-2">Your Postcode</label>
              <input type="text" id="postcode" placeholder="e.g. BA16 0HW" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
              <p class="text-sm text-gray-500 mt-2">We cover all of Somerset - enter your postcode to confirm service availability</p>
            </div>

            <button type="button" id="continue-to-step-2" class="w-full btn-primary text-lg py-4 disabled:opacity-50 disabled:cursor-not-allowed">
              Continue to Your Details
            </button>
          </div>

          <!-- Step 2: Customer Details -->
          <div id="step-2" class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 2: Your Details</h2>
            
            <form id="customer-form" class="space-y-6">
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
                  <input type="text" id="first-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                  <label for="last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
                  <input type="text" id="last-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
              </div>
              
              <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
                <input type="email" id="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              
              <div>
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
                <input type="tel" id="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
              </div>
              
              <div>
                <label for="full-address" class="block text-sm font-medium text-gray-700 mb-2">Full Property Address *</label>
                <textarea id="full-address" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Include house number, street name, town, and postcode"></textarea>
              </div>

              <div>
                <label for="special-instructions" class="block text-sm font-medium text-gray-700 mb-2">Special Instructions (Optional)</label>
                <textarea id="special-instructions" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Access details, locked gates, dogs, preferred times, etc."></textarea>
              </div>

              <!-- Photos Upload -->
              <div>
                <label for="photos" class="block text-sm font-medium text-gray-700 mb-2">Property Photos (Optional)</label>
                <input type="file" id="photos" name="photos" multiple accept="image/*" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-primary/90">
                <p class="text-sm text-gray-500 mt-1">Upload photos of your property to help us provide accurate service (max 5MB each)</p>
              </div>
            </form>

            <div class="flex space-x-4 mt-8">
              <button type="button" id="back-to-step-1" class="flex-1 btn-secondary">
                Back to Services
              </button>
              <button type="button" id="continue-to-step-3" class="flex-1 btn-primary">
                Continue to Schedule
              </button>
            </div>
          </div>

          <!-- Step 3: Schedule & Payment -->
          <div id="step-3" class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 hidden">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Step 3: Schedule & Payment</h2>
            
            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">Preferred Start Date</label>
                <input type="date" id="preferred-date" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <p class="text-sm text-gray-500 mt-1">We'll contact you to confirm the exact date and time</p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-3">Preferred Contact Method</label>
                <div class="grid grid-cols-3 gap-3">
                  <label class="flex items-center">
                    <input type="radio" name="contact-method" value="email" checked class="w-4 h-4 text-primary border-gray-300 focus:ring-primary">
                    <span class="ml-2">Email</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="contact-method" value="phone" class="w-4 h-4 text-primary border-gray-300 focus:ring-primary">
                    <span class="ml-2">Phone</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="contact-method" value="whatsapp" class="w-4 h-4 text-primary border-gray-300 focus:ring-primary">
                    <span class="ml-2">WhatsApp</span>
                  </label>
                </div>
              </div>

              <!-- reCAPTCHA -->
              <div id="recaptcha"></div>
            </div>

            <div class="flex space-x-4 mt-8">
              <button type="button" id="back-to-step-2" class="flex-1 btn-secondary">
                Back to Details
              </button>
              <button type="button" id="submit-booking" class="flex-1 btn-primary text-lg py-4">
                Complete Booking
              </button>
            </div>
          </div>
        </div>

        <!-- Right Column: Price Summary & Info -->
        <div class="lg:col-span-1">
          <div class="sticky top-8 space-y-6">
            
            <!-- Price Summary -->
            <div class="bg-gradient-to-br from-primary/5 to-accent/5 rounded-xl p-6 border border-primary/20">
              <h3 class="text-xl font-bold text-gray-900 mb-4">Your Quote</h3>
              <div id="price-summary" class="space-y-3">
                <div class="text-center text-gray-500">
                  <div class="text-4xl mb-2">💰</div>
                  <p>Select your services to see pricing</p>
                </div>
              </div>
            </div>

            <!-- Service Benefits -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">Why Choose Us?</h3>
              <div class="space-y-3">
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">Fully Insured</div>
                    <div class="text-sm text-gray-600">£2M public liability</div>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">48-Hour Guarantee</div>
                    <div class="text-sm text-gray-600">Spot-free guarantee</div>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">Pure Water System</div>
                    <div class="text-sm text-gray-600">Streak-free finish</div>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">Professional Service</div>
                    <div class="text-sm text-gray-600">Since 2019</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Info -->
            <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
              <h3 class="text-lg font-bold text-gray-900 mb-4">Need Help?</h3>
              <div class="space-y-3">
                <a href="tel:01458860339" class="flex items-center space-x-3 text-gray-700 hover:text-primary transition-colors">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                  </svg>
                  <span>01458 860339</span>
                </a>
                <a href="https://wa.me/447415526331" target="_blank" class="flex items-center space-x-3 text-gray-700 hover:text-primary transition-colors">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.104"/>
                  </svg>
                  <span>WhatsApp Us</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </WidgetWrapper>

  <!-- Pricing Reference Tables (Hidden by default, can be shown for transparency) -->
  <WidgetWrapper>
    <div class="max-w-4xl mx-auto px-4">
      <div class="text-center mb-8">
        <button id="show-pricing-tables" class="text-primary hover:text-primary/80 font-medium">
          View Detailed Pricing Tables
        </button>
      </div>
      
      <div id="pricing-tables" class="hidden space-y-8">
        <!-- Standard Properties Pricing -->
        <div class="bg-white rounded-lg shadow-lg border border-gray-100 overflow-hidden">
          <div class="bg-gray-50 px-6 py-4 border-b">
            <h3 class="text-xl font-semibold">Standard Properties Pricing</h3>
            <p class="text-sm text-gray-600">Regular 4-6 week cleaning schedule</p>
          </div>
          <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <h4 class="font-semibold mb-3">Houses</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between"><span>1-2 bedroom</span><span class="font-semibold">£15-£18</span></div>
                  <div class="flex justify-between"><span>3 bedroom</span><span class="font-semibold">£22-£28</span></div>
                  <div class="flex justify-between"><span>4 bedroom</span><span class="font-semibold">£30-£38</span></div>
                  <div class="flex justify-between"><span>5+ bedroom</span><span class="font-semibold">£40-£55</span></div>
                </div>
              </div>
              <div>
                <h4 class="font-semibold mb-3">Flats/Apartments</h4>
                <div class="space-y-2 text-sm">
                  <div class="flex justify-between"><span>1-2 bedroom</span><span class="font-semibold">£12-£15</span></div>
                  <div class="flex justify-between"><span>3 bedroom</span><span class="font-semibold">£18-£22</span></div>
                  <div class="flex justify-between"><span>4 bedroom</span><span class="font-semibold">£25-£32</span></div>
                  <div class="flex justify-between"><span>5+ bedroom</span><span class="font-semibold">£35-£42</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </WidgetWrapper>

  <!-- FAQs Section -->
  <FAQs
    title="Booking FAQs"
    subtitle="Common questions about our online booking system"
    columns={2}
    items={[
      { 
        title: 'How accurate are the online prices?', 
        description: 'Our online prices are based on typical properties and are 95% accurate. Final pricing is confirmed after we see your property details or photos.' 
      },
      { 
        title: 'Can I change my booking after submitting?', 
        description: 'Yes! Contact us within 24 hours to modify services, dates, or frequencies. We\'re flexible and want to meet your needs.' 
      },
      { 
        title: 'How does payment work?', 
        description: 'We collect payment after each clean via Direct Debit (preferred), card, or bank transfer. No upfront payments required.' 
      },
      { 
        title: 'What if I\'m not satisfied?', 
        description: 'We offer a 48-hour spot-free guarantee. Report any issues and we\'ll return to fix them free of charge.' 
      },
      { 
        title: 'Do you provide equipment and materials?', 
        description: 'Yes, we bring all professional equipment, pure water systems, and cleaning materials. You don\'t need to provide anything.' 
      },
      { 
        title: 'What if it rains?', 
        description: 'We clean in light rain as pure water dries streak-free. In heavy rain, we\'ll reschedule your appointment automatically.' 
      },
      { 
        title: 'Can I book a one-off clean?', 
        description: 'Yes, though regular customers get priority booking. One-off cleans have a 20% premium due to additional setup time.' 
      },
      { 
        title: 'How do I cancel my regular service?', 
        description: 'You can cancel anytime with 7 days notice. No contracts or cancellation fees - we want happy customers.' 
      },
    ]}
  />

  <!-- Call to Action -->
  <CallToAction
    title="Prefer to speak to someone?"
    subtitle="Our friendly team is available Monday-Friday 8am-6pm to help with quotes and bookings."
    actions={[
      { variant: 'primary', text: 'Call 01458 860339', href: 'tel:01458860339', icon: 'tabler:phone' },
      { text: 'WhatsApp Quote', href: 'https://wa.me/447415526331?text=Hi%20Somerset%20Window%20Cleaning%2C%20I%27d%20like%20to%20book%20window%20cleaning', icon: 'tabler:brand-whatsapp' },
    ]}
  />
</Layout>

<script>
// Pricing logic - Preserved from instant-quote system
const pricing = {
  windows: {
    house: { 1: 15, 2: 18, 3: 25, 4: 35, 5: 45 },
    flat: { 1: 12, 2: 15, 3: 20, 4: 28, 5: 35 },
    commercial: 50,
    other: 30
  },
  gutters: {
    house: { 1: 25, 2: 30, 3: 40, 4: 50, 5: 60 },
    flat: { 1: 20, 2: 25, 3: 30, 4: 40, 5: 50 },
    commercial: 80,
    other: 40
  },
  fascia: {
    house: { 1: 20, 2: 25, 3: 35, 4: 45, 5: 50 },
    flat: { 1: 15, 2: 20, 3: 25, 4: 35, 5: 40 },
    commercial: 60,
    other: 30
  },
  conservatory: {
    house: { 1: 30, 2: 40, 3: 50, 4: 70, 5: 80 },
    flat: { 1: 25, 2: 30, 3: 40, 4: 60, 5: 70 },
    commercial: 100,
    other: 50
  },
  solar: {
    house: { 1: 40, 2: 50, 3: 60, 4: 80, 5: 100 },
    flat: { 1: 30, 2: 40, 3: 50, 4: 70, 5: 90 },
    commercial: 150,
    other: 70
  }
};

// Frequency multipliers - Preserved from pricing page
const frequencyMultipliers = {
  '4': 0.9,   // 10% discount
  '6': 0.95,  // 5% discount  
  '8': 1.0,   // standard
  '12': 1.1,  // 10% premium
  'one-off': 1.2  // 20% premium
};

let selectedPropertyType = '';
let currentStep = 1;
let bookingData = {};

// reCAPTCHA setup
const RECAPTCHA_SITE_KEY = '6LcuV6ArAAAAAOSDE-o2Evkq704THds9m9KQpQge';
let recaptchaWidgetId = null;

function initRecaptcha() {
  const container = document.getElementById('recaptcha');
  if (container && window.grecaptcha && recaptchaWidgetId === null) {
    try {
      recaptchaWidgetId = window.grecaptcha.render('recaptcha', {
        sitekey: RECAPTCHA_SITE_KEY,
        theme: 'light',
      });
    } catch (e) {
      console.log('reCAPTCHA error:', e);
    }
  }
}

// Load reCAPTCHA
if (!window.grecaptcha) {
  const script = document.createElement('script');
  script.src = 'https://www.google.com/recaptcha/api.js?onload=initRecaptcha&render=explicit';
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
  window.initRecaptcha = initRecaptcha;
} else {
  initRecaptcha();
}

// Property type selection
document.querySelectorAll('.property-type-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.property-type-btn').forEach(b => {
      b.classList.remove('border-primary', 'bg-primary/5');
      b.classList.add('border-gray-200');
    });
    
    btn.classList.add('border-primary', 'bg-primary/5');
    btn.classList.remove('border-gray-200');
    
    selectedPropertyType = btn.dataset.type;
    
    // Show/hide bedrooms section
    const bedroomsSection = document.getElementById('bedrooms-section');
    if (selectedPropertyType === 'house' || selectedPropertyType === 'flat') {
      bedroomsSection.classList.remove('hidden');
    } else {
      bedroomsSection.classList.add('hidden');
    }
    
    updatePricing();
  });
});

// Service selection and pricing updates
document.querySelectorAll('.service-checkbox').forEach(checkbox => {
  checkbox.addEventListener('change', () => {
    const serviceOption = checkbox.closest('.service-option');
    if (checkbox.checked) {
      serviceOption.classList.add('border-primary', 'bg-primary/5');
      serviceOption.classList.remove('border-gray-200');
    } else {
      serviceOption.classList.remove('border-primary', 'bg-primary/5');
      serviceOption.classList.add('border-gray-200');
    }
    updatePricing();
  });
});

// Update pricing when bedrooms or frequency changes
document.getElementById('bedrooms').addEventListener('change', updatePricing);
document.getElementById('frequency').addEventListener('change', updatePricing);

function updatePricing() {
  if (!selectedPropertyType) return;
  
  const bedrooms = document.getElementById('bedrooms').value;
  const frequency = document.getElementById('frequency').value;
  const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
  
  if ((selectedPropertyType === 'house' || selectedPropertyType === 'flat') && !bedrooms && selectedServices.some(s => s !== 'windows')) {
    return;
  }
  
  let total = 0;
  const breakdown = [];
  
  selectedServices.forEach(service => {
    let price = 0;
    
    if (selectedPropertyType === 'commercial' || selectedPropertyType === 'other') {
      price = pricing[service][selectedPropertyType];
    } else {
      const bedroomKey = bedrooms || '2'; // Default to 2 bedrooms if not selected
      price = pricing[service][selectedPropertyType][bedroomKey];
    }
    
    total += price;
    breakdown.push({ service, price });
  });
  
  // Apply frequency multiplier
  const multiplier = frequencyMultipliers[frequency] || 1;
  const finalTotal = Math.round(total * multiplier);
  
  // Update price summary
  updatePriceSummary(breakdown, multiplier, finalTotal, frequency);
}

function updatePriceSummary(breakdown, multiplier, total, frequency) {
  const summary = document.getElementById('price-summary');
  
  if (breakdown.length === 0) {
    summary.innerHTML = `
      <div class="text-center text-gray-500">
        <div class="text-4xl mb-2">💰</div>
        <p>Select your services to see pricing</p>
      </div>
    `;
    return;
  }
  
  const frequencyText = {
    '4': '10% discount applied',
    '6': '5% discount applied', 
    '8': 'Standard rate',
    '12': '10% premium applied',
    'one-off': '20% premium applied'
  };
  
  summary.innerHTML = `
    <div class="space-y-3">
      <div class="text-center">
        <div class="text-3xl font-bold text-primary">£${total}</div>
        <div class="text-sm text-gray-600">${frequencyText[frequency]}</div>
      </div>
      <div class="border-t pt-3 space-y-2">
        ${breakdown.map(item => `
          <div class="flex justify-between text-sm">
            <span>${item.service.charAt(0).toUpperCase() + item.service.slice(1)}</span>
            <span>£${item.price}</span>
          </div>
        `).join('')}
      </div>
      <div class="border-t pt-3">
        <div class="flex justify-between text-sm">
          <span>Frequency:</span>
          <span>${document.getElementById('frequency').selectedOptions[0].text.split(' - ')[0]}</span>
        </div>
        ${frequency !== 'one-off' ? `
          <div class="flex justify-between text-sm">
            <span>Next clean:</span>
            <span>${getNextCleanDate(frequency)}</span>
          </div>
        ` : ''}
      </div>
    </div>
  `;
}

function getNextCleanDate(frequency) {
  if (frequency === 'one-off') return 'One-time service';
  
  const weeks = parseInt(frequency);
  const nextDate = new Date();
  nextDate.setDate(nextDate.getDate() + (weeks * 7));
  return nextDate.toLocaleDateString('en-GB');
}

// Step navigation
document.getElementById('continue-to-step-2').addEventListener('click', () => {
  if (validateStep1()) {
    showStep(2);
  }
});

document.getElementById('back-to-step-1').addEventListener('click', () => showStep(1));
document.getElementById('continue-to-step-3').addEventListener('click', () => {
  if (validateStep2()) {
    showStep(3);
  }
});
document.getElementById('back-to-step-2').addEventListener('click', () => showStep(2));

function validateStep1() {
  if (!selectedPropertyType) {
    alert('Please select a property type');
    return false;
  }
  
  const bedrooms = document.getElementById('bedrooms').value;
  if ((selectedPropertyType === 'house' || selectedPropertyType === 'flat') && !bedrooms) {
    alert('Please select number of bedrooms');
    return false;
  }
  
  const postcode = document.getElementById('postcode').value.trim();
  if (!postcode) {
    alert('Please enter your postcode');
    return false;
  }
  
  const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked'));
  if (selectedServices.length === 0) {
    alert('Please select at least one service');
    return false;
  }
  
  return true;
}

function validateStep2() {
  const requiredFields = ['first-name', 'last-name', 'email', 'phone', 'full-address'];
  for (const fieldId of requiredFields) {
    const field = document.getElementById(fieldId);
    if (!field.value.trim()) {
      alert(`Please fill in the ${field.previousElementSibling.textContent.replace(' *', '')}`);
      field.focus();
      return false;
    }
  }
  
  // Basic email validation
  const email = document.getElementById('email').value;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address');
    document.getElementById('email').focus();
    return false;
  }
  
  return true;
}

function showStep(step) {
  // Hide all steps
  document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.add('hidden'));
  
  // Show target step
  document.getElementById(`step-${step}`).classList.remove('hidden');
  
  // Update progress indicators
  updateProgressIndicators(step);
  
  currentStep = step;
  
  // Initialize reCAPTCHA when reaching step 3
  if (step === 3 && window.grecaptcha && recaptchaWidgetId === null) {
    setTimeout(initRecaptcha, 100);
  }
}

function updateProgressIndicators(activeStep) {
  for (let i = 1; i <= 3; i++) {
    const indicator = document.getElementById(`step-${i}-indicator`);
    const progress = document.getElementById(`progress-${i}`);
    
    if (i < activeStep) {
      // Completed step
      indicator.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold';
      indicator.innerHTML = '✓';
      if (progress) progress.style.width = '100%';
    } else if (i === activeStep) {
      // Active step
      indicator.className = 'w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-bold';
      indicator.textContent = i;
      if (progress) progress.style.width = '50%';
    } else {
      // Future step
      indicator.className = 'w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-bold';
      indicator.textContent = i;
      if (progress) progress.style.width = '0%';
    }
    
    // Update step labels
    const label = indicator.nextElementSibling;
    if (label) {
      if (i <= activeStep) {
        label.classList.remove('text-gray-500');
        label.classList.add('text-gray-900');
      } else {
        label.classList.add('text-gray-500');
        label.classList.remove('text-gray-900');
      }
    }
  }
}

// Submit booking
document.getElementById('submit-booking').addEventListener('click', async () => {
  // Validate reCAPTCHA
  let captchaToken = null;
  try {
    if (window.grecaptcha && recaptchaWidgetId !== null) {
      captchaToken = window.grecaptcha.getResponse(recaptchaWidgetId);
    }
  } catch (e) {
    console.log('reCAPTCHA error:', e);
  }
  
  if (!captchaToken) {
    alert('Please complete the reCAPTCHA verification');
    return;
  }
  
  const button = document.getElementById('submit-booking');
  const originalText = button.textContent;
  button.disabled = true;
  button.textContent = 'Submitting...';
  
  try {
    // Collect all form data
    const formData = new FormData();
    
    // Basic details
    formData.append('propertyType', selectedPropertyType);
    formData.append('bedrooms', document.getElementById('bedrooms').value);
    formData.append('postcode', document.getElementById('postcode').value);
    formData.append('frequency', document.getElementById('frequency').value);
    
    // Services
    const selectedServices = Array.from(document.querySelectorAll('.service-checkbox:checked')).map(cb => cb.value);
    selectedServices.forEach(service => formData.append('services', service));
    
    // Customer details
    formData.append('firstName', document.getElementById('first-name').value);
    formData.append('lastName', document.getElementById('last-name').value);
    formData.append('email', document.getElementById('email').value);
    formData.append('phone', document.getElementById('phone').value);
    formData.append('address', document.getElementById('full-address').value);
    formData.append('specialInstructions', document.getElementById('special-instructions').value);
    
    // Preferred contact method
    const contactMethod = document.querySelector('input[name="contact-method"]:checked').value;
    formData.append('preferredContactMethod', contactMethod);
    
    // Preferred date
    const preferredDate = document.getElementById('preferred-date').value;
    if (preferredDate) {
      formData.append('preferredDate', preferredDate);
    }
    
    // Photos
    const photoFiles = document.getElementById('photos').files;
    for (let i = 0; i < photoFiles.length; i++) {
      formData.append('photos', photoFiles[i]);
    }
    
    // Convert FormData to the format expected by the API
    const data = Object.fromEntries(formData.entries());
    
    // Calculate pricing for submission
    let total = 0;
    selectedServices.forEach(service => {
      if (selectedPropertyType === 'commercial' || selectedPropertyType === 'other') {
        total += pricing[service][selectedPropertyType];
      } else {
        const bedroomKey = data.bedrooms || '2';
        total += pricing[service][selectedPropertyType][bedroomKey];
      }
    });
    
    const multiplier = frequencyMultipliers[data.frequency] || 1;
    total = Math.round(total * multiplier);
    
    // Handle photo files - convert to base64 for API
    const photoPromises = Array.from(photoFiles).map(file => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve({
          name: file.name,
          type: file.type,
          data: reader.result
        });
        reader.onerror = () => resolve(null);
        reader.readAsDataURL(file);
      });
    });
    
    const attachments = (await Promise.all(photoPromises)).filter(Boolean);
    
    // Format payload for existing API
    const payload = {
      customerName: `${data.firstName} ${data.lastName}`,
      email: data.email,
      mobile: data.phone,
      addressLine1: data.address,
      townCity: '',
      postcode: data.postcode,
      propertyType: selectedPropertyType,
      frequency: data.frequency.toString().toLowerCase().replace(/\s\(.*\)/, '').replace(' ', ''),
      servicesRequested: selectedServices.reduce((acc, service) => {
        acc[service + 'Cleaning'] = true;
        return acc;
      }, { windowCleaning: selectedServices.includes('windows') }),
      preferredContactMethod: contactMethod,
      specialRequirements: data.specialInstructions,
      preferredDate: preferredDate,
      recaptchaToken: captchaToken,
      attachments: attachments,
      totalCost: total
    };
    
    // Submit to API
    const response = await fetch('https://window-cleaning-booking-system-6k15.vercel.app/api/submit-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    const result = await response.json();
    
    if (result?.success) {
      // Success - show confirmation
      document.getElementById('step-3').innerHTML = `
        <div class="text-center py-12">
          <div class="text-6xl mb-4">✅</div>
          <h2 class="text-2xl font-bold text-gray-900 mb-4">Booking Confirmed!</h2>
          <p class="text-lg text-gray-600 mb-2">Your booking reference is:</p>
          <p class="text-2xl font-bold text-primary mb-6">${result.bookingReference}</p>
          <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6">
            <h3 class="font-semibold text-green-800 mb-2">What happens next?</h3>
            <div class="text-sm text-green-700 space-y-1">
              <p>• We'll contact you within 24 hours to confirm your appointment</p>
              <p>• You'll receive a confirmation email with all details</p>
              <p>• Payment is collected after each clean via your chosen method</p>
              <p>• We'll send a courtesy text before each visit</p>
            </div>
          </div>
          <div class="space-y-4">
            <button onclick="window.location.reload()" class="btn-primary">Book Another Service</button>
            <div>
              <a href="tel:01458860339" class="btn-secondary mr-4">Call Us</a>
              <a href="/" class="btn-secondary">Back to Home</a>
            </div>
          </div>
        </div>
      `;
      
      // Reset reCAPTCHA
      try {
        if (window.grecaptcha && recaptchaWidgetId !== null) {
          window.grecaptcha.reset(recaptchaWidgetId);
        }
      } catch (e) {}
      
    } else {
      alert(result?.error || 'There was an error submitting your booking. Please try again or call us at 01458 860339.');
    }
    
  } catch (error) {
    console.error('Booking submission error:', error);
    alert('Unable to submit booking right now. Please try again later or call us at 01458 860339.');
  } finally {
    button.disabled = false;
    button.textContent = originalText;
  }
});

// Show/hide pricing tables
document.getElementById('show-pricing-tables').addEventListener('click', () => {
  const tables = document.getElementById('pricing-tables');
  const button = document.getElementById('show-pricing-tables');
  
  if (tables.classList.contains('hidden')) {
    tables.classList.remove('hidden');
    button.textContent = 'Hide Pricing Tables';
  } else {
    tables.classList.add('hidden');
    button.textContent = 'View Detailed Pricing Tables';
  }
});

// Initialize pricing on load
updatePricing();
</script>