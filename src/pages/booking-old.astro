---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import WidgetWrapper from '~/components/ui/WidgetWrapper.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import CallToAction from '~/components/widgets/CallToAction.astro';
import Image from '~/components/common/Image.astro';

const metadata = {
  title: 'Book Window Cleaning Online - Somerset Window Cleaning | Instant Quote & Booking',
  description: 'Book professional window cleaning in Somerset online. Get instant pricing for residential and commercial properties. Fully insured service with transparent pricing.',
};
---

<Layout metadata={metadata}>
  <!-- Hero Section -->
  <Hero>
    <Fragment slot="title">
      Professional Window Cleaning <span class="text-accent">Book Online</span>
    </Fragment>
    <Fragment slot="subtitle">
      Instant Quote & Book Online - Select your property type for transparent pricing
    </Fragment>
    <Fragment slot="bg">
      <Image src="~/assets/images/solar-panels.jpeg" alt="" width={1600} height={900} layout="cover" style="width:100%; height:100%; object-fit:cover; opacity:0.35;" />
      <div class="absolute inset-0 bg-gradient-to-br from-gray-800/60 via-gray-700/60 to-blue-900/60"></div>
    </Fragment>
  </Hero>

  <!-- Multi-Step Booking Form -->
  <WidgetWrapper>
    <div class="bg-gray-900 min-h-screen">
      <div class="max-w-6xl mx-auto px-4 py-8">
        
        <!-- Progress Steps -->
        <div class="mb-8">
          <div class="flex items-center justify-center space-x-2 sm:space-x-4 mb-6">
            <div class="flex items-center">
              <div id="step-1-indicator" class="w-6 h-6 sm:w-8 sm:h-8 bg-red-600 text-white rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300">1</div>
              <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-white">Property</span>
            </div>
            <div class="w-4 sm:w-6 h-0.5 bg-gray-600">
              <div id="progress-1" class="h-full bg-red-600 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center">
              <div id="step-2-indicator" class="w-6 h-6 sm:w-8 sm:h-8 bg-gray-600 text-gray-300 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300">2</div>
              <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-gray-300">Services</span>
            </div>
            <div class="w-4 sm:w-6 h-0.5 bg-gray-600">
              <div id="progress-2" class="h-full bg-red-600 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center">
              <div id="step-3-indicator" class="w-6 h-6 sm:w-8 sm:h-8 bg-gray-600 text-gray-300 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300">3</div>
              <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-gray-300">Details</span>
            </div>
            <div class="w-4 sm:w-6 h-0.5 bg-gray-600">
              <div id="progress-3" class="h-full bg-red-600 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="flex items-center">
              <div id="step-4-indicator" class="w-6 h-6 sm:w-8 sm:h-8 bg-gray-600 text-gray-300 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300">4</div>
              <span class="ml-1 sm:ml-2 text-xs sm:text-sm font-medium text-gray-300">Review</span>
            </div>
          </div>
        </div>

      <div class="grid lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Form Steps -->
        <div class="lg:col-span-2 space-y-8">
          
          <!-- Step 1: Property Selection -->
          <div id="step-1" class="bg-gray-800 rounded-lg shadow-sm border border-gray-700 p-4 sm:p-6">
            <h2 class="text-xl font-bold text-white mb-3">Select Your Property Type</h2>
            <p class="text-gray-300 mb-6 text-sm">Choose your property type to get instant transparent pricing</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              
              <!-- 1-2 Bedroom Properties -->
              <div class="property-card group relative bg-gray-700 border-2 border-gray-600 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-red-500 transition-all duration-200 cursor-pointer"
                   data-service-id="property12bed" data-type="1-2 Bedroom" data-bedrooms="1-2 Bed" data-base-price="20">
                <div class="text-center">
                  <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-white">1-2 Bedroom</h3>
                  <p class="text-xs text-gray-300 mb-2">Small Property</p>
                  <div class="text-sm font-bold text-red-400">From £20</div>
                </div>
              </div>

              <!-- 3 Bed Semi-Detached -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="sdh23" data-type="Semi-Detached" data-bedrooms="3 Bed" data-base-price="25">
                <div class="text-center">
                  <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm-1 15H5v-6h6v6zm8 0h-6v-6h6v6z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">3 Bed Semi-Detached</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      3 beds
                    </span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">From £25</div>
                </div>
              </div>

              <!-- 3 Bed Detached -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="dh23" data-type="Detached" data-bedrooms="3 Bed" data-base-price="30">
                <div class="text-center">
                  <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 3l10 9h-3v8h-5v-6H10v6H5v-8H2L12 3z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">3 Bed Detached</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      3 beds
                    </span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">From £30</div>
                </div>
              </div>

              <!-- 4 Bed Semi-Detached -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="sdh4" data-type="Semi-Detached" data-bedrooms="4 Bed" data-base-price="30">
                <div class="text-center">
                  <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm-1 15H5v-6h6v6zm8 0h-6v-6h6v6z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">4 Bed Semi-Detached</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      4 beds
                    </span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">From £30</div>
                </div>
              </div>

              <!-- 4 Bed Detached -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="dh4" data-type="Detached" data-bedrooms="4 Bed" data-base-price="35">
                <div class="text-center">
                  <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 3l10 9h-3v8h-5v-6H10v6H5v-8H2L12 3z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">4 Bed Detached</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      4 beds
                    </span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">From £35</div>
                </div>
              </div>

              <!-- 5 Bed Semi-Detached -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="sdh5" data-type="Semi-Detached" data-bedrooms="5 Bed" data-base-price="35">
                <div class="text-center">
                  <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-teal-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3zm-1 15H5v-6h6v6zm8 0h-6v-6h6v6z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">5 Bed Semi-Detached</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      5 beds
                    </span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">From £35</div>
                </div>
              </div>

              <!-- 5 Bed Detached -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="dh5" data-type="Detached" data-bedrooms="5 Bed" data-base-price="40">
                <div class="text-center">
                  <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 3l10 9h-3v8h-5v-6H10v6H5v-8H2L12 3z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">5 Bed Detached</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500 flex items-center">
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24"><path d="M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3z"/></svg>
                      5 beds
                    </span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">From £40</div>
                </div>
              </div>

              <!-- 6+ Beds Custom -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="custom6plus" data-type="Properties" data-bedrooms="6+ Beds & Bespoke" data-base-price="0" data-is-custom="true">
                <div class="text-center">
                  <div class="w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-pink-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2l9 7v11H15v-7h-2v7H3V9l9-7zm0 2.2L5 9v10h6v-7h2v7h6V9l-7-4.8z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">6+ Beds & Bespoke</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500">6+ beds</span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">Custom Quote</div>
                </div>
              </div>

              <!-- Commercial -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="commercial" data-type="Commercial Property" data-bedrooms="All Types" data-base-price="0" data-is-commercial="true">
                <div class="text-center">
                  <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">Commercial Property</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500">All Types</span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">Business Enquiry</div>
                </div>
              </div>

              <!-- General Enquiry -->
              <div class="property-card group relative bg-white border-2 border-gray-200 p-4 rounded-lg shadow-sm hover:shadow-md hover:border-blue-500 transition-all duration-200 cursor-pointer"
                   data-service-id="other_services_enquiry" data-type="General Enquiry" data-bedrooms="Other Services" data-is-general="true">
                <div class="text-center">
                  <div class="w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <svg class="w-6 h-6 text-emerald-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/>
                    </svg>
                  </div>
                  <h3 class="text-sm font-semibold mb-1 text-gray-800">General Enquiry</h3>
                  <div class="flex items-center justify-center mb-2">
                    <span class="text-xs text-gray-500">Gutters, Solar, etc.</span>
                  </div>
                  <div class="text-sm font-bold text-blue-600">Get Quote</div>
                </div>
              </div>

            </div>

            <!-- Frequency Selection (shown after property selection) -->
            <div id="frequency-selection" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <h3 class="text-base font-semibold mb-4 text-gray-900">Select Cleaning Frequency</h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button type="button" class="frequency-btn p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 bg-white"
                        data-frequency-id="4-weekly" data-adjustment="0">
                  <div class="text-sm font-semibold text-gray-900">4 Weekly</div>
                  <div class="text-xs text-gray-600">Most Popular</div>
                </button>
                <button type="button" class="frequency-btn p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 bg-white"
                        data-frequency-id="8-weekly" data-adjustment="3">
                  <div class="text-sm font-semibold text-gray-900">8 Weekly</div>
                  <div class="text-xs text-gray-600">+£3</div>
                </button>
                <button type="button" class="frequency-btn p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 bg-white"
                        data-frequency-id="12-weekly" data-adjustment="5">
                  <div class="text-sm font-semibold text-gray-900">12 Weekly</div>
                  <div class="text-xs text-gray-600">+£5</div>
                </button>
                <button type="button" class="frequency-btn p-3 border-2 border-gray-200 rounded-lg text-center hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 bg-white"
                        data-frequency-id="adhoc" data-adjustment="20">
                  <div class="text-sm font-semibold text-gray-900">One-off</div>
                  <div class="text-xs text-gray-600">+£20</div>
                </button>
              </div>
              <button type="button" id="continue-to-step-2" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Continue to Additional Services
              </button>
            </div>
          </div>

          <!-- Step 2: Additional Services -->
          <div id="step-2" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Additional Services</h2>
            <div id="additional-services-content">
              <!-- Content will be populated by JavaScript based on property type -->
            </div>
          </div>

          <!-- Step 3: Property Details -->
          <div id="step-3" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Property Details</h2>
            <div id="property-details-content">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>

          <!-- Step 4: Review & Submit -->
          <div id="step-4" class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 sm:p-6 hidden">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Review & Submit</h2>
            <div id="review-content">
              <!-- Content will be populated by JavaScript -->
            </div>
          </div>

        </div>

        <!-- Right Column: Price Summary & Info -->
        <div class="lg:col-span-1">
          <div class="sticky top-8 space-y-4">
            
            <!-- Price Summary -->
            <div class="bg-gradient-to-br from-blue-50 to-green-50 rounded-lg p-4 border border-blue-200">
              <h3 class="text-lg font-bold text-gray-900 mb-3">Your Quote</h3>
              <div id="price-summary" class="space-y-2">
                <div class="text-center text-gray-500">
                  <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M7 15h2c0 1.08 1.37 2 3 2s3-.92 3-2c0-1.1-1.04-1.5-3.24-2.03C9.64 12.44 7 11.78 7 9c0-1.79 1.47-3.31 3.5-3.82V3h3v2.18C15.53 5.69 17 7.21 17 9h-2c0-1.08-1.37-2-3-2s-3 .92-3 2c0 1.1 1.04 1.5 3.24 2.03C14.36 11.56 17 12.22 17 15c0 1.79-1.47 3.31-3.5 3.82V21h-3v-2.18C8.47 18.31 7 16.79 7 15z"/>
                  </svg>
                  <p class="text-sm">Select your property type to see pricing</p>
                </div>
              </div>
            </div>

            <!-- Service Benefits -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <h3 class="text-base font-bold text-gray-900 mb-3">Why Choose Us?</h3>
              <div class="space-y-3">
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">Fully Insured</div>
                    <div class="text-sm text-gray-600">£2M public liability</div>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">48-Hour Guarantee</div>
                    <div class="text-sm text-gray-600">Spot-free guarantee</div>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">Pure Water System</div>
                    <div class="text-sm text-gray-600">Streak-free finish</div>
                  </div>
                </div>
                <div class="flex items-start space-x-3">
                  <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>
                  <div>
                    <div class="font-medium">Professional Service</div>
                    <div class="text-sm text-gray-600">Since 2019</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Contact Info -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
              <h3 class="text-base font-bold text-gray-900 mb-3">Need Help?</h3>
              <div class="space-y-3">
                <a href="tel:01458860339" class="flex items-center space-x-3 text-gray-700 hover:text-primary transition-colors">
                  <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"/>
                  </svg>
                  <span>01458 860339</span>
                </a>
                <a href="https://wa.me/447415526331" target="_blank" class="flex items-center space-x-3 text-gray-700 hover:text-primary transition-colors">
                  <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.104"/>
                  </svg>
                  <span>WhatsApp Us</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </WidgetWrapper>

  <!-- FAQs Section -->
  <FAQs
    title="Booking FAQs"
    subtitle="Common questions about our online booking system"
    columns={2}
    items={[
      { 
        title: 'How accurate are the online prices?', 
        description: 'Our online prices are based on typical properties and are 95% accurate. Final pricing is confirmed after we see your property details.' 
      },
      { 
        title: 'Can I change my booking after submitting?', 
        description: 'Yes! Contact us within 24 hours to modify services, dates, or frequencies. We\'re flexible and want to meet your needs.' 
      },
      { 
        title: 'How does payment work?', 
        description: 'We collect payment after each clean via Direct Debit (preferred), card, or bank transfer. No upfront payments required.' 
      },
      { 
        title: 'What if I\'m not satisfied?', 
        description: 'We offer a 48-hour spot-free guarantee. Report any issues and we\'ll return to fix them free of charge.' 
      },
      { 
        title: 'Do you provide equipment and materials?', 
        description: 'Yes, we bring all professional equipment, pure water systems, and cleaning materials. You don\'t need to provide anything.' 
      },
      { 
        title: 'What if it rains?', 
        description: 'We clean in light rain as pure water dries streak-free. In heavy rain, we\'ll reschedule your appointment automatically.' 
      },
    ]}
  />

  <!-- Call to Action -->
  <CallToAction
    title="Prefer to speak to someone?"
    subtitle="Our friendly team is available Monday-Friday 8am-6pm to help with quotes and bookings."
    actions={[
      { variant: 'primary', text: 'Call 01458 860339', href: 'tel:01458860339', icon: 'tabler:phone' },
      { text: 'WhatsApp Quote', href: 'https://wa.me/447415526331?text=Hi%20Somerset%20Window%20Cleaning%2C%20I%27d%20like%20to%20book%20window%20cleaning', icon: 'tabler:brand-whatsapp' },
    ]}
  />
</Layout>

<script>
import { calculateGutterClearingPrice, calculateAddonPrice } from '../utils/bookingPricing.ts';

// Global form state
let formData = {
  selectedWindowService: null,
  propertyType: '',
  bedrooms: '',
  initialWindowPrice: 0,
  selectedFrequency: '',
  frequencyId: '',
  isCustomQuote: false,
  isCommercial: false,
  isResidential: false,
  isGeneralEnquiry: false,
  additionalServices: {
    conservatoryRoof: false,
    fasciaSoffitGutter: false,
    gutterClearing: false
  },
  quoteRequests: [],
  generalEnquiry: {
    services: [],
    frequency: '',
    additionalInfo: ''
  },
  customResidential: {
    propertyStyle: '',
    services: [],
    frequency: '',
    additionalInfo: ''
  },
  commercial: {
    propertyType: '',
    size: '',
    services: [],
    frequency: '',
    additionalInfo: ''
  },
  propertyDetails: {
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    address: '',
    postcode: '',
    accessInfo: '',
    additionalInfo: ''
  },
  totalPrice: 0,
  grandTotal: 0,
  subTotalBeforeDiscount: 0,
  windowCleaningDiscount: 0
};

let currentStep = 1;
let selectedPropertyCard = null;
let selectedFrequencyCard = null;

// EmailJS Configuration
const EMAILJS_SERVICE_ID = 'service_cwqvutf';
const EMAILJS_TEMPLATE_ID = 'template_booking_form';
const EMAILJS_USER_ID = 'ljhOh4QVqK9iQDVWO';

// reCAPTCHA Configuration
const RECAPTCHA_SITE_KEY = '6LcuV6ArAAAAAOSDE-o2Evkq704THds9m9KQpQge';
let recaptchaWidgetId = null;

// Load EmailJS
(function() {
  const script = document.createElement('script');
  script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
  script.onload = function() {
    window.emailjs.init(EMAILJS_USER_ID);
  };
  document.head.appendChild(script);
})();

// Load reCAPTCHA
function initRecaptcha() {
  const container = document.getElementById('recaptcha');
  if (container && window.grecaptcha && recaptchaWidgetId === null) {
    try {
      recaptchaWidgetId = window.grecaptcha.render('recaptcha', {
        sitekey: RECAPTCHA_SITE_KEY,
        theme: 'light',
      });
    } catch (e) {
      console.log('reCAPTCHA error:', e);
    }
  }
}

if (!window.grecaptcha) {
  const script = document.createElement('script');
  script.src = 'https://www.google.com/recaptcha/api.js?onload=initRecaptcha&render=explicit';
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
  window.initRecaptcha = initRecaptcha;
} else {
  initRecaptcha();
}

// Frequency adjustment functions
const frequencyAdjustments = {
  '4-weekly': (price) => price,
  '8-weekly': (price) => price + 3,
  '12-weekly': (price) => price + 5,
  'adhoc': (price) => price + 20
};

// Property card selection with enhanced interactions
document.querySelectorAll('.property-card').forEach(card => {
  // Add hover effect for better UX
  card.addEventListener('mouseenter', () => {
    if (!card.classList.contains('border-blue-500')) {
      card.classList.add('shadow-md');
    }
  });
  
  card.addEventListener('mouseleave', () => {
    if (!card.classList.contains('border-blue-500')) {
      card.classList.remove('shadow-md');
    }
  });
  
  card.addEventListener('click', () => {
    // Add loading state
    card.style.transform = 'scale(0.98)';
    setTimeout(() => {
      card.style.transform = 'scale(1)';
    }, 150);
    
    // Clear previous selections
    document.querySelectorAll('.property-card').forEach(c => {
      c.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-md');
      c.classList.add('border-gray-200', 'shadow-sm');
    });
    
    // Select current card with smooth animation
    card.classList.add('border-blue-500', 'bg-blue-50', 'shadow-md');
    card.classList.remove('border-gray-200', 'shadow-sm');
    selectedPropertyCard = card;
    
    const serviceId = card.dataset.serviceId;
    const type = card.dataset.type;
    const bedrooms = card.dataset.bedrooms;
    const basePrice = parseInt(card.dataset.basePrice) || 0;
    const isCustom = card.dataset.isCustom === 'true';
    const isCommercial = card.dataset.isCommercial === 'true';
    const isGeneral = card.dataset.isGeneral === 'true';
    
    // Update form data
    formData.propertyType = type;
    formData.bedrooms = bedrooms;
    formData.isCustomQuote = isCustom;
    formData.isCommercial = isCommercial;
    formData.isGeneralEnquiry = isGeneral;
    formData.isResidential = !isCustom && !isCommercial && !isGeneral;
    
    // Show/hide frequency selection based on property type
    const frequencySection = document.getElementById('frequency-selection');
    if (isCustom || isCommercial || isGeneral) {
      frequencySection.classList.add('hidden');
      // For custom quotes, skip to appropriate step
      if (isGeneral) {
        formData.selectedFrequency = '';
        formData.frequencyId = '';
        showStep(2); // Go to additional services for general enquiry
      } else {
        formData.selectedFrequency = isCommercial ? 'Business Enquiry' : 'Custom Quote';
        formData.frequencyId = isCommercial ? 'business_enquiry' : 'custom_quote';
        showStep(3); // Go to property details for quotes
      }
    } else {
      frequencySection.classList.remove('hidden');
      formData.selectedWindowService = {
        id: serviceId,
        type: type,
        bedrooms: bedrooms,
        basePrice: basePrice
      };
    }
    
    updatePriceSummary();
  });
});

// Frequency selection with enhanced interactions
document.querySelectorAll('.frequency-btn').forEach(btn => {
  // Add hover and focus effects
  btn.addEventListener('mouseenter', () => {
    if (!btn.classList.contains('border-blue-500')) {
      btn.classList.add('shadow-sm');
    }
  });
  
  btn.addEventListener('mouseleave', () => {
    if (!btn.classList.contains('border-blue-500')) {
      btn.classList.remove('shadow-sm');
    }
  });
  
  btn.addEventListener('click', () => {
    // Add click animation
    btn.style.transform = 'scale(0.95)';
    setTimeout(() => {
      btn.style.transform = 'scale(1)';
    }, 100);
    
    // Clear previous selections
    document.querySelectorAll('.frequency-btn').forEach(b => {
      b.classList.remove('border-blue-500', 'bg-blue-100', 'shadow-sm');
      b.classList.add('border-gray-200', 'bg-white');
    });
    
    // Select current button with smooth animation
    btn.classList.add('border-blue-500', 'bg-blue-100', 'shadow-sm');
    btn.classList.remove('border-gray-200', 'bg-white');
    selectedFrequencyCard = btn;
    
    const frequencyId = btn.dataset.frequencyId;
    const adjustment = parseInt(btn.dataset.adjustment) || 0;
    
    // Update form data
    formData.frequencyId = frequencyId;
    formData.selectedFrequency = btn.querySelector('div').textContent;
    
    if (formData.selectedWindowService) {
      const adjustedPrice = formData.selectedWindowService.basePrice + adjustment;
      formData.initialWindowPrice = adjustedPrice;
      formData.grandTotal = adjustedPrice;
      formData.subTotalBeforeDiscount = adjustedPrice;
      formData.selectedWindowService.calculatedPrice = adjustedPrice;
    }
    
    // Enable continue button
    document.getElementById('continue-to-step-2').disabled = false;
    
    updatePriceSummary();
  });
});

// Step navigation
document.getElementById('continue-to-step-2').addEventListener('click', () => {
  showStep(2);
});

function showStep(step) {
  // Hide all steps with fade out effect
  for (let i = 1; i <= 4; i++) {
    const stepElement = document.getElementById(`step-${i}`);
    stepElement.style.opacity = '0';
    setTimeout(() => {
      stepElement.classList.add('hidden');
    }, 150);
  }
  
  // Show target step with fade in effect
  setTimeout(() => {
    const targetStep = document.getElementById(`step-${step}`);
    targetStep.classList.remove('hidden');
    targetStep.style.opacity = '0';
    
    // Smooth scroll to top of form
    targetStep.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    setTimeout(() => {
      targetStep.style.opacity = '1';
    }, 50);
  }, 200);
  
  // Update progress indicators
  updateProgressIndicators(step);
  
  currentStep = step;
  
  // Populate step content
  setTimeout(() => {
    if (step === 2) {
      populateAdditionalServices();
    } else if (step === 3) {
      populatePropertyDetails();
    } else if (step === 4) {
      populateReviewAndSubmit();
    }
  }, 250);
}

function updateProgressIndicators(activeStep) {
  for (let i = 1; i <= 4; i++) {
    const indicator = document.getElementById(`step-${i}-indicator`);
    const progress = document.getElementById(`progress-${i}`);
    
    if (i < activeStep) {
      // Completed step
      indicator.className = 'w-6 h-6 sm:w-8 sm:h-8 bg-green-500 text-white rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300';
      indicator.innerHTML = '✓';
      if (progress) progress.style.width = '100%';
    } else if (i === activeStep) {
      // Active step
      indicator.className = 'w-6 h-6 sm:w-8 sm:h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300';
      indicator.textContent = i;
      if (progress) progress.style.width = '50%';
    } else {
      // Future step
      indicator.className = 'w-6 h-6 sm:w-8 sm:h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold transition-all duration-300';
      indicator.textContent = i;
      if (progress) progress.style.width = '0%';
    }
    
    // Update step labels
    const label = indicator.nextElementSibling;
    if (label) {
      if (i <= activeStep) {
        label.classList.remove('text-gray-500');
        label.classList.add('text-gray-900');
      } else {
        label.classList.add('text-gray-500');
        label.classList.remove('text-gray-900');
      }
    }
  }
}

function populateAdditionalServices() {
  const content = document.getElementById('additional-services-content');
  
  if (formData.isGeneralEnquiry) {
    // General enquiry form
    content.innerHTML = `
      <p class="text-gray-600 mb-6">Tell us about the services you're interested in:</p>
      
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Services Required (select all that apply)</label>
          <div class="grid md:grid-cols-2 gap-4">
            <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg hover:border-blue-500 cursor-pointer transition-all duration-200">
              <input type="checkbox" name="general-services" value="windowCleaning" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
              <div>
                <div class="text-sm font-medium">Window Cleaning</div>
                <div class="text-xs text-gray-600">Inside & outside cleaning</div>
              </div>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="general-services" value="conservatoryWindows" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <div>
                <div class="font-medium">Conservatory Windows</div>
                <div class="text-sm text-gray-600">Panels and frames</div>
              </div>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="general-services" value="gutterClearing" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <div>
                <div class="font-medium">Gutter Clearing</div>
                <div class="text-sm text-gray-600">High-reach vacuum system</div>
              </div>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="general-services" value="fasciaSoffitGutter" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <div>
                <div class="font-medium">Fascia & Soffit</div>
                <div class="text-sm text-gray-600">UPVC cleaning</div>
              </div>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="general-services" value="conservatoryRoof" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <div>
                <div class="font-medium">Conservatory Roof</div>
                <div class="text-sm text-gray-600">Complete cleaning</div>
              </div>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="general-services" value="solarPanels" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <div>
                <div class="font-medium">Solar Panel Cleaning</div>
                <div class="text-sm text-gray-600">Maintain efficiency</div>
              </div>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Preferred Frequency</label>
          <select id="general-frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Select frequency</option>
            <option value="oneOff">One-off clean</option>
            <option value="4weekly">Every 4 weeks</option>
            <option value="8weekly">Every 8 weeks</option>
            <option value="12weekly">Every 12 weeks</option>
            <option value="asRequired">As required</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Additional Information</label>
          <textarea id="general-additional-info" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                    placeholder="Any specific requirements or questions?"></textarea>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button type="button" onclick="showStep(1)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Back to Property Type
        </button>
        <button type="button" onclick="continueFromGeneralEnquiry()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Continue to Details
        </button>
      </div>
    `;
  } else if (formData.isResidential) {
    // Standard residential additional services
    content.innerHTML = `
      <p class="text-gray-600 mb-6">Add extra services to your window cleaning:</p>
      
      <div class="grid md:grid-cols-2 gap-6">
        <div class="addon-service-card border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 transition-all duration-200">
          <label class="flex items-start cursor-pointer">
            <input type="checkbox" name="addon-services" value="gutterClearing" class="addon-checkbox mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <div class="ml-2 flex-1">
              <div class="text-sm font-medium text-gray-900">Gutter Clearing</div>
              <div class="text-xs text-gray-600 mt-1">High-reach vacuum system with photo report</div>
              <div class="text-xs font-semibold text-blue-600 mt-1" id="gutter-price">+£${calculateGutterClearingPrice(formData.propertyType, formData.bedrooms)}</div>
            </div>
          </label>
        </div>

        <div class="addon-service-card border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 transition-all duration-200">
          <label class="flex items-start cursor-pointer">
            <input type="checkbox" name="addon-services" value="fasciaSoffitGutter" class="addon-checkbox mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <div class="ml-2 flex-1">
              <div class="text-sm font-medium text-gray-900">Fascia & Soffit Cleaning</div>
              <div class="text-xs text-gray-600 mt-1">UPVC cleaning, removes algae and grime</div>
              <div class="text-xs font-semibold text-blue-600 mt-1" id="fascia-price">+£${calculateAddonPrice('fasciaSoffitGutter', formData.propertyType, formData.bedrooms)}</div>
            </div>
          </label>
        </div>

        <div class="addon-service-card border-2 border-gray-200 rounded-lg p-4 hover:border-blue-400 transition-all duration-200">
          <label class="flex items-start cursor-pointer">
            <input type="checkbox" name="addon-services" value="conservatoryRoof" class="addon-checkbox mt-1 w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
            <div class="ml-2 flex-1">
              <div class="text-sm font-medium text-gray-900">Conservatory Roof Cleaning</div>
              <div class="text-xs text-gray-600 mt-1">Panels and frames, algae removal</div>
              <div class="text-xs font-semibold text-blue-600 mt-1">Quote Required</div>
            </div>
          </label>
        </div>
      </div>

      <div class="flex space-x-3 mt-6">
        <button type="button" onclick="showStep(1)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Back to Property Type
        </button>
        <button type="button" onclick="continueFromAdditionalServices()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Continue to Details
        </button>
      </div>
    `;

    // Add addon service selection handlers with enhanced interactions
    document.querySelectorAll('.addon-checkbox').forEach(checkbox => {
      const serviceCard = checkbox.closest('.addon-service-card');
      
      // Add hover effects
      serviceCard.addEventListener('mouseenter', () => {
        if (!checkbox.checked) {
          serviceCard.classList.add('shadow-md');
        }
      });
      
      serviceCard.addEventListener('mouseleave', () => {
        if (!checkbox.checked) {
          serviceCard.classList.remove('shadow-md');
        }
      });
      
      checkbox.addEventListener('change', () => {
        const serviceName = checkbox.value;
        
        // Add selection animation
        serviceCard.style.transform = 'scale(0.98)';
        setTimeout(() => {
          serviceCard.style.transform = 'scale(1)';
        }, 150);
        
        if (checkbox.checked) {
          serviceCard.classList.add('border-blue-500', 'bg-blue-50', 'shadow-md');
          serviceCard.classList.remove('border-gray-200');
          formData.additionalServices[serviceName] = true;
          
          if (serviceName === 'conservatoryRoof') {
            formData.quoteRequests.push('conservatoryRoofCleaning');
          }
        } else {
          serviceCard.classList.remove('border-blue-500', 'bg-blue-50', 'shadow-md');
          serviceCard.classList.add('border-gray-200');
          formData.additionalServices[serviceName] = false;
          
          if (serviceName === 'conservatoryRoof') {
            formData.quoteRequests = formData.quoteRequests.filter(req => req !== 'conservatoryRoofCleaning');
          }
        }
        
        updatePriceSummary();
      });
    });
  }
}

function continueFromGeneralEnquiry() {
  // Collect general enquiry data
  const selectedServices = Array.from(document.querySelectorAll('input[name="general-services"]:checked')).map(cb => cb.value);
  const frequency = document.getElementById('general-frequency').value;
  const additionalInfo = document.getElementById('general-additional-info').value;
  
  if (selectedServices.length === 0) {
    alert('Please select at least one service');
    return;
  }
  
  formData.generalEnquiry = {
    services: selectedServices,
    frequency: frequency,
    additionalInfo: additionalInfo
  };
  
  showStep(3);
}

function continueFromAdditionalServices() {
  // Calculate total with addons
  let total = formData.initialWindowPrice || 0;
  
  Object.keys(formData.additionalServices).forEach(serviceName => {
    if (formData.additionalServices[serviceName] && serviceName !== 'conservatoryRoof') {
      total += calculateAddonPrice(serviceName, formData.propertyType, formData.bedrooms);
    }
  });
  
  formData.grandTotal = total;
  formData.subTotalBeforeDiscount = total;
  
  showStep(3);
}

function populatePropertyDetails() {
  const content = document.getElementById('property-details-content');
  
  if (formData.isCommercial) {
    // Commercial property details form
    content.innerHTML = `
      <p class="text-gray-600 mb-6">Tell us about your commercial property:</p>
      
      <div class="space-y-6">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
            <select id="commercial-property-type" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="">Select type</option>
              <option value="office">Office</option>
              <option value="retail">Retail Store</option>
              <option value="restaurant">Restaurant/Café</option>
              <option value="warehouse">Warehouse</option>
              <option value="medical">Medical/Healthcare</option>
              <option value="school">School/Education</option>
              <option value="hotel">Hotel/Hospitality</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Approximate Size</label>
            <select id="commercial-size" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
              <option value="">Select size</option>
              <option value="small">Small (under 2,000 sq ft)</option>
              <option value="medium">Medium (2,000-10,000 sq ft)</option>
              <option value="large">Large (10,000-50,000 sq ft)</option>
              <option value="multi-storey">Multi-storey building</option>
              <option value="complex">Large complex/campus</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Services Required</label>
          <div class="grid md:grid-cols-2 gap-4">
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="commercial-services" value="windowCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Window Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="commercial-services" value="gutterCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Gutter Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="commercial-services" value="fasciaSoffitCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Fascia & Soffit Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="commercial-services" value="claddingCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Cladding Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="commercial-services" value="signageCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Signage Cleaning</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Frequency</label>
          <select id="commercial-frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Select frequency</option>
            <option value="weekly">Weekly</option>
            <option value="fortnightly">Fortnightly</option>
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="bi-annually">Bi-annually</option>
            <option value="annually">Annually</option>
            <option value="one-off">One-off</option>
            <option value="other">Other</option>
          </select>
        </div>

        ${getContactDetailsForm()}

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Additional Information</label>
          <textarea id="commercial-additional-info" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                    placeholder="Health & safety requirements, access details, special considerations..."></textarea>
        </div>
      </div>

      <div class="flex space-x-4 mt-8">
        <button type="button" onclick="showStep(1)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Back to Property Type
        </button>
        <button type="button" onclick="continueFromCommercialDetails()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Continue to Review
        </button>
      </div>
    `;
  } else if (formData.isCustomQuote) {
    // Custom residential property details
    content.innerHTML = `
      <p class="text-gray-600 mb-6">Tell us about your custom property:</p>
      
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Property Style</label>
          <div class="grid md:grid-cols-2 gap-4">
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="radio" name="custom-property-style" value="detached" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary mr-3">
              <span>Large Detached/Unique</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="radio" name="custom-property-style" value="semiDetachedLarge" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary mr-3">
              <span>Semi-Detached Large/Extended</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="radio" name="custom-property-style" value="terracedMulti" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary mr-3">
              <span>Terraced/Multi-storey Large</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="radio" name="custom-property-style" value="bungalowLarge" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary mr-3">
              <span>Bungalow Large/Complex</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="radio" name="custom-property-style" value="apartmentBlock" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary mr-3">
              <span>Apartment Block</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="radio" name="custom-property-style" value="otherCustomProperty" class="w-5 h-5 text-primary border-gray-300 focus:ring-primary mr-3">
              <span>Other Custom Property</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Services Required</label>
          <div class="grid md:grid-cols-2 gap-4">
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="custom-services" value="windowCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Window Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="custom-services" value="gutterCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Gutter Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="custom-services" value="fasciaSoffitCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Fascia & Soffit Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="custom-services" value="conservatoryWindowCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Conservatory Window Cleaning</span>
            </label>
            <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-primary cursor-pointer transition-all">
              <input type="checkbox" name="custom-services" value="conservatoryRoofCleaning" class="w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary mr-3">
              <span>Conservatory Roof Cleaning</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Frequency</label>
          <select id="custom-frequency" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
            <option value="">Select frequency</option>
            <option value="4-weekly">4 Weekly</option>
            <option value="8-weekly">8 Weekly</option>
            <option value="12-weekly">12 Weekly</option>
            <option value="one-off">One-off</option>
            <option value="other">Other</option>
          </select>
        </div>

        ${getContactDetailsForm()}

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Additional Information</label>
          <textarea id="custom-additional-info" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                    placeholder="Property details, access information, special requirements..."></textarea>
        </div>
      </div>

      <div class="flex space-x-4 mt-8">
        <button type="button" onclick="showStep(1)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Back to Property Type
        </button>
        <button type="button" onclick="continueFromCustomDetails()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Continue to Review
        </button>
      </div>
    `;
  } else {
    // Standard residential property details
    content.innerHTML = `
      <p class="text-gray-600 mb-6">Please provide your contact and property details:</p>
      
      <div class="space-y-6">
        ${getContactDetailsForm()}
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Access Information</label>
          <textarea id="access-info" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                    placeholder="Locked gates, dogs, preferred times, etc."></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Additional Information</label>
          <textarea id="additional-info" rows="2" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" 
                    placeholder="Any other requirements or questions?"></textarea>
        </div>
      </div>

      <div class="flex space-x-4 mt-8">
        <button type="button" onclick="showStep(2)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Back to Services
        </button>
        <button type="button" onclick="continueFromPropertyDetails()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Continue to Review
        </button>
      </div>
    `;
  }
}

function getContactDetailsForm() {
  return `
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <label for="first-name" class="block text-sm font-medium text-gray-700 mb-2">First Name *</label>
        <input type="text" id="first-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
      </div>
      <div>
        <label for="last-name" class="block text-sm font-medium text-gray-700 mb-2">Last Name *</label>
        <input type="text" id="last-name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
      </div>
    </div>
    
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address *</label>
      <input type="email" id="email" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label>
      <input type="tel" id="phone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
    </div>
    
    <div>
      <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Property Address *</label>
      <textarea id="address" rows="3" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Include house number, street name, town, and postcode"></textarea>
    </div>
    
    <div>
      <label for="postcode" class="block text-sm font-medium text-gray-700 mb-2">Postcode *</label>
      <input type="text" id="postcode" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g. BA16 0HW">
    </div>
  `;
}

function continueFromPropertyDetails() {
  if (!validateContactDetails()) return;
  
  // Collect property details
  formData.propertyDetails = {
    firstName: document.getElementById('first-name').value,
    lastName: document.getElementById('last-name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    address: document.getElementById('address').value,
    postcode: document.getElementById('postcode').value,
    accessInfo: document.getElementById('access-info')?.value || '',
    additionalInfo: document.getElementById('additional-info')?.value || ''
  };
  
  showStep(4);
}

function continueFromCommercialDetails() {
  if (!validateContactDetails()) return;
  
  const services = Array.from(document.querySelectorAll('input[name="commercial-services"]:checked')).map(cb => cb.value);
  if (services.length === 0) {
    alert('Please select at least one service');
    return;
  }
  
  formData.commercial = {
    propertyType: document.getElementById('commercial-property-type').value,
    size: document.getElementById('commercial-size').value,
    services: services,
    frequency: document.getElementById('commercial-frequency').value,
    additionalInfo: document.getElementById('commercial-additional-info').value
  };
  
  formData.propertyDetails = {
    firstName: document.getElementById('first-name').value,
    lastName: document.getElementById('last-name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    address: document.getElementById('address').value,
    postcode: document.getElementById('postcode').value,
    accessInfo: '',
    additionalInfo: formData.commercial.additionalInfo
  };
  
  showStep(4);
}

function continueFromCustomDetails() {
  if (!validateContactDetails()) return;
  
  const propertyStyle = document.querySelector('input[name="custom-property-style"]:checked')?.value;
  const services = Array.from(document.querySelectorAll('input[name="custom-services"]:checked')).map(cb => cb.value);
  
  if (!propertyStyle) {
    alert('Please select a property style');
    return;
  }
  
  if (services.length === 0) {
    alert('Please select at least one service');
    return;
  }
  
  formData.customResidential = {
    propertyStyle: propertyStyle,
    services: services,
    frequency: document.getElementById('custom-frequency').value,
    additionalInfo: document.getElementById('custom-additional-info').value
  };
  
  formData.propertyDetails = {
    firstName: document.getElementById('first-name').value,
    lastName: document.getElementById('last-name').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    address: document.getElementById('address').value,
    postcode: document.getElementById('postcode').value,
    accessInfo: '',
    additionalInfo: formData.customResidential.additionalInfo
  };
  
  showStep(4);
}

function validateContactDetails() {
  const requiredFields = ['first-name', 'last-name', 'email', 'phone', 'address', 'postcode'];
  for (const fieldId of requiredFields) {
    const field = document.getElementById(fieldId);
    if (!field?.value.trim()) {
      alert(`Please fill in the ${field?.previousElementSibling?.textContent?.replace(' *', '') || fieldId}`);
      field?.focus();
      return false;
    }
  }
  
  // Basic email validation
  const email = document.getElementById('email').value;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address');
    document.getElementById('email').focus();
    return false;
  }
  
  return true;
}

function populateReviewAndSubmit() {
  const content = document.getElementById('review-content');
  
  let servicesSummary = '';
  let totalPrice = 0;
  
  if (formData.isResidential && formData.selectedWindowService) {
    servicesSummary += `
      <div class="border-b border-gray-200 pb-4 mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">Window Cleaning Service</h4>
        <div class="flex justify-between text-sm">
          <span>${formData.propertyType} ${formData.bedrooms} - ${formData.selectedFrequency}</span>
          <span class="font-semibold">£${formData.initialWindowPrice}</span>
        </div>
      </div>
    `;
    totalPrice += formData.initialWindowPrice;
    
    // Add addon services
    Object.keys(formData.additionalServices).forEach(serviceName => {
      if (formData.additionalServices[serviceName]) {
        const serviceDisplayName = serviceName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        if (serviceName === 'conservatoryRoof') {
          servicesSummary += `
            <div class="flex justify-between text-sm">
              <span>${serviceDisplayName}</span>
              <span class="font-semibold">Quote Required</span>
            </div>
          `;
        } else {
          const price = calculateAddonPrice(serviceName, formData.propertyType, formData.bedrooms);
          servicesSummary += `
            <div class="flex justify-between text-sm">
              <span>${serviceDisplayName}</span>
              <span class="font-semibold">£${price}</span>
            </div>
          `;
          totalPrice += price;
        }
      }
    });
  } else if (formData.isGeneralEnquiry) {
    servicesSummary += `
      <div class="border-b border-gray-200 pb-4 mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">General Enquiry</h4>
        <div class="text-sm">
          <div><strong>Services:</strong> ${formData.generalEnquiry.services.join(', ')}</div>
          <div><strong>Frequency:</strong> ${formData.generalEnquiry.frequency}</div>
          ${formData.generalEnquiry.additionalInfo ? `<div><strong>Notes:</strong> ${formData.generalEnquiry.additionalInfo}</div>` : ''}
        </div>
      </div>
    `;
  } else if (formData.isCommercial) {
    servicesSummary += `
      <div class="border-b border-gray-200 pb-4 mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">Commercial Enquiry</h4>
        <div class="text-sm">
          <div><strong>Property Type:</strong> ${formData.commercial.propertyType}</div>
          <div><strong>Size:</strong> ${formData.commercial.size}</div>
          <div><strong>Services:</strong> ${formData.commercial.services.join(', ')}</div>
          <div><strong>Frequency:</strong> ${formData.commercial.frequency}</div>
        </div>
      </div>
    `;
  } else if (formData.isCustomQuote) {
    servicesSummary += `
      <div class="border-b border-gray-200 pb-4 mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">Custom Property Quote</h4>
        <div class="text-sm">
          <div><strong>Property Style:</strong> ${formData.customResidential.propertyStyle}</div>
          <div><strong>Services:</strong> ${formData.customResidential.services.join(', ')}</div>
          <div><strong>Frequency:</strong> ${formData.customResidential.frequency}</div>
        </div>
      </div>
    `;
  }
  
  content.innerHTML = `
    <div class="space-y-6">
      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Service Summary</h3>
        ${servicesSummary}
        ${totalPrice > 0 ? `
          <div class="border-t border-gray-300 pt-4 mt-4">
            <div class="flex justify-between font-bold text-lg">
              <span>Total:</span>
              <span class="text-primary">£${totalPrice}</span>
            </div>
          </div>
        ` : ''}
      </div>

      <div class="bg-gray-50 rounded-lg p-6">
        <h3 class="font-semibold text-gray-900 mb-4">Contact Details</h3>
        <div class="text-sm space-y-1">
          <div><strong>Name:</strong> ${formData.propertyDetails.firstName} ${formData.propertyDetails.lastName}</div>
          <div><strong>Email:</strong> ${formData.propertyDetails.email}</div>
          <div><strong>Phone:</strong> ${formData.propertyDetails.phone}</div>
          <div><strong>Address:</strong> ${formData.propertyDetails.address}</div>
          <div><strong>Postcode:</strong> ${formData.propertyDetails.postcode}</div>
          ${formData.propertyDetails.accessInfo ? `<div><strong>Access Info:</strong> ${formData.propertyDetails.accessInfo}</div>` : ''}
          ${formData.propertyDetails.additionalInfo ? `<div><strong>Additional Info:</strong> ${formData.propertyDetails.additionalInfo}</div>` : ''}
        </div>
      </div>

      <!-- reCAPTCHA -->
      <div id="recaptcha"></div>

      <div class="flex space-x-4">
        <button type="button" onclick="showStep(3)" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all duration-200">
          Back to Details
        </button>
        <button type="button" onclick="submitBooking()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-4 px-6 rounded-lg transition-all duration-200 text-base" id="submit-btn">
          Submit Booking
        </button>
      </div>
    </div>
  `;
  
  // Initialize reCAPTCHA
  setTimeout(initRecaptcha, 100);
}

async function submitBooking() {
  // Validate reCAPTCHA
  let captchaToken = null;
  try {
    if (window.grecaptcha && recaptchaWidgetId !== null) {
      captchaToken = window.grecaptcha.getResponse(recaptchaWidgetId);
    }
  } catch (e) {
    console.log('reCAPTCHA error:', e);
  }
  
  if (!captchaToken) {
    // Create a more user-friendly alert
    showNotification('Please complete the reCAPTCHA verification', 'error');
    return;
  }
  
  const submitBtn = document.getElementById('submit-btn');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-4 w-4 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Submitting...';
  submitBtn.classList.add('opacity-75');
  
  try {
    // Prepare email data
    const emailData = {
      to_email: 'dan@danlee.dev', // Replace with actual recipient
      reply_to: formData.propertyDetails.email,
      customer_name: `${formData.propertyDetails.firstName} ${formData.propertyDetails.lastName}`,
      customer_email: formData.propertyDetails.email,
      customer_phone: formData.propertyDetails.phone,
      property_address: formData.propertyDetails.address,
      postcode: formData.propertyDetails.postcode,
      service_type: formData.isCommercial ? 'Commercial Enquiry' : formData.isCustomQuote ? 'Custom Quote' : formData.isGeneralEnquiry ? 'General Enquiry' : 'Standard Residential',
      property_type: formData.propertyType || 'N/A',
      bedrooms: formData.bedrooms || 'N/A',
      frequency: formData.selectedFrequency || 'N/A',
      services_summary: getServicesSummary(),
      total_price: formData.grandTotal || 0,
      additional_info: formData.propertyDetails.additionalInfo || formData.propertyDetails.accessInfo || 'None',
      recaptcha_token: captchaToken
    };
    
    // Send email via EmailJS
    const result = await window.emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailData);
    
    if (result.status === 200) {
      // Success with enhanced styling
      document.getElementById('step-4').innerHTML = `
        <div class="text-center py-8">
          <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
              <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
          </div>
          <h2 class="text-xl font-bold text-gray-900 mb-3">Booking Submitted Successfully!</h2>
          <p class="text-base text-gray-600 mb-6">Thank you for choosing Somerset Window Cleaning.</p>
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6 text-left">
            <h3 class="font-semibold text-green-800 mb-2 text-sm">What happens next?</h3>
            <div class="text-xs text-green-700 space-y-1">
              <p>• We'll contact you within 24 hours to confirm your booking</p>
              <p>• You'll receive a confirmation email with all details</p>
              <p>• For standard services, we'll arrange a convenient time</p>
              <p>• For quotes, we'll provide detailed pricing based on your requirements</p>
            </div>
          </div>
          <div class="space-y-3">
            <button onclick="window.location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-lg transition-all duration-200 w-full sm:w-auto">Book Another Service</button>
            <div class="flex flex-col sm:flex-row gap-2 justify-center">
              <a href="tel:01458860339" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200 text-sm">Call Us</a>
              <a href="/" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-200 text-sm">Back to Home</a>
            </div>
          </div>
        </div>
      `;
    } else {
      throw new Error('Email sending failed');
    }
    
  } catch (error) {
    console.error('Booking submission error:', error);
    showNotification('Unable to submit booking right now. Please try again later or call us at 01458 860339.', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
    submitBtn.classList.remove('opacity-75');
  }
}

// Enhanced notification system
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full ${
    type === 'error' ? 'bg-red-100 border border-red-200 text-red-800' :
    type === 'success' ? 'bg-green-100 border border-green-200 text-green-800' :
    'bg-blue-100 border border-blue-200 text-blue-800'
  }`;
  
  notification.innerHTML = `
    <div class="flex items-start">
      <div class="flex-shrink-0">
        ${type === 'error' ? 
          '<svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>' :
          '<svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'
        }
      </div>
      <div class="ml-3 flex-1">
        <p class="text-sm font-medium">${message}</p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="ml-4 flex-shrink-0">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  `;
  
  document.body.appendChild(notification);
  
  // Animate in
  setTimeout(() => {
    notification.classList.remove('translate-x-full');
  }, 100);
  
  // Auto remove after 5 seconds
  setTimeout(() => {
    notification.classList.add('translate-x-full');
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 5000);
}

function getServicesSummary() {
  let summary = '';
  
  if (formData.isResidential && formData.selectedWindowService) {
    summary += `Window Cleaning: ${formData.propertyType} ${formData.bedrooms} - ${formData.selectedFrequency} (£${formData.initialWindowPrice})\n`;
    
    Object.keys(formData.additionalServices).forEach(serviceName => {
      if (formData.additionalServices[serviceName]) {
        const serviceDisplayName = serviceName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        if (serviceName === 'conservatoryRoof') {
          summary += `${serviceDisplayName}: Quote Required\n`;
        } else {
          const price = calculateAddonPrice(serviceName, formData.propertyType, formData.bedrooms);
          summary += `${serviceDisplayName}: £${price}\n`;
        }
      }
    });
  } else if (formData.isGeneralEnquiry) {
    summary += `General Enquiry Services: ${formData.generalEnquiry.services.join(', ')}\n`;
    summary += `Frequency: ${formData.generalEnquiry.frequency}\n`;
  } else if (formData.isCommercial) {
    summary += `Commercial Property: ${formData.commercial.propertyType} (${formData.commercial.size})\n`;
    summary += `Services: ${formData.commercial.services.join(', ')}\n`;
    summary += `Frequency: ${formData.commercial.frequency}\n`;
  } else if (formData.isCustomQuote) {
    summary += `Custom Property: ${formData.customResidential.propertyStyle}\n`;
    summary += `Services: ${formData.customResidential.services.join(', ')}\n`;
    summary += `Frequency: ${formData.customResidential.frequency}\n`;
  }
  
  return summary;
}

function updatePriceSummary() {
  const summary = document.getElementById('price-summary');
  
  if (formData.isResidential && formData.selectedWindowService && formData.frequencyId) {
    let total = formData.initialWindowPrice || 0;
    let breakdown = [`Window Cleaning: £${formData.initialWindowPrice}`];
    
    // Add addon services
    Object.keys(formData.additionalServices).forEach(serviceName => {
      if (formData.additionalServices[serviceName] && serviceName !== 'conservatoryRoof') {
        const price = calculateAddonPrice(serviceName, formData.propertyType, formData.bedrooms);
        total += price;
        const displayName = serviceName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        breakdown.push(`${displayName}: £${price}`);
      }
    });
    
    if (formData.additionalServices.conservatoryRoof) {
      breakdown.push('Conservatory Roof: Quote Required');
    }
    
    summary.innerHTML = `
      <div class="space-y-2">
        <div class="text-center">
          <div class="text-2xl font-bold text-blue-600">£${total}</div>
          <div class="text-xs text-gray-600">${formData.selectedFrequency}</div>
        </div>
        <div class="border-t pt-2 space-y-1 text-xs">
          ${breakdown.map(item => `<div>${item}</div>`).join('')}
        </div>
      </div>
    `;
  } else if (formData.propertyType) {
    summary.innerHTML = `
      <div class="text-center text-gray-600">
        <div class="text-lg font-bold text-blue-600">${formData.isCommercial ? 'Business Enquiry' : formData.isCustomQuote ? 'Custom Quote' : formData.isGeneralEnquiry ? 'Quote Required' : 'Quote'}</div>
        <div class="text-xs mt-1">We'll provide detailed pricing based on your requirements</div>
      </div>
    `;
  } else {
    summary.innerHTML = `
      <div class="text-center text-gray-500">
        <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="M7 15h2c0 1.08 1.37 2 3 2s3-.92 3-2c0-1.1-1.04-1.5-3.24-2.03C9.64 12.44 7 11.78 7 9c0-1.79 1.47-3.31 3.5-3.82V3h3v2.18C15.53 5.69 17 7.21 17 9h-2c0-1.08-1.37-2-3-2s-3 .92-3 2c0 1.1 1.04 1.5 3.24 2.03C14.36 11.56 17 12.22 17 15c0 1.79-1.47 3.31-3.5 3.82V21h-3v-2.18C8.47 18.31 7 16.79 7 15z"/>
        </svg>
        <p class="text-sm">Select your property type to see pricing</p>
      </div>
    `;
  }
}

// Initialize pricing on load
updatePriceSummary();

// Add global styles for enhanced animations and interactions
const style = document.createElement('style');
style.textContent = `
  .property-card, .frequency-btn, .addon-service-card {
    transition: all 0.2s ease-in-out;
  }
  
  .property-card:hover {
    transform: translateY(-2px);
  }
  
  .frequency-btn:hover {
    transform: translateY(-1px);
  }
  
  .addon-service-card:hover {
    transform: translateY(-1px);
  }
  
  /* Loading spinner animation */
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .animate-spin {
    animation: spin 1s linear infinite;
  }
  
  /* Custom focus styles */
  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #3B82F6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  
  /* Step transition effects */
  [id^="step-"] {
    transition: opacity 0.3s ease-in-out;
  }
  
  /* Progress indicator animation */
  [id^="progress-"] {
    transition: width 0.5s ease-in-out;
  }
  
  /* Button hover effects */
  button {
    transition: all 0.2s ease-in-out;
  }
  
  button:hover:not(:disabled) {
    transform: translateY(-1px);
  }
  
  button:active:not(:disabled) {
    transform: translateY(0);
  }
  
  /* Notification entrance animation */
  .notification-enter {
    animation: slideInRight 0.3s ease-out;
  }
  
  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
  
  /* Mobile responsive improvements */
  @media (max-width: 640px) {
    .property-card {
      padding: 12px;
    }
    
    .frequency-btn {
      padding: 8px;
    }
    
    .addon-service-card {
      padding: 12px;
    }
  }
`;

document.head.appendChild(style);

// Initialize all interactive elements
setTimeout(() => {
  // Add entrance animations to cards
  document.querySelectorAll('.property-card').forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    setTimeout(() => {
      card.style.transition = 'all 0.4s ease-out';
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, index * 100);
  });
}, 100);
</script>