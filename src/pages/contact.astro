---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import ContactUs from '~/components/widgets/Contact.astro';
import heroImage from '~/assets/images/DJI_0007.JPG';
import { Icon } from 'astro-icon/components';

// Read query params for postcode/coverage
const url = new URL(Astro.url);
const postcode = url.searchParams.get('postcode') || '';
const covered = url.searchParams.get('covered') === '1';
const whatsappText = `Hi Somerset Window Cleaning, my postcode is ${postcode} and I'd like a quote`;
const whatsappHref = `https://wa.me/447415526331?text=${encodeURIComponent(whatsappText)}`;

const metadata = {
  title: 'Contact Somerset Window Cleaning | Get Quote | Call 01458 860339',
  description: 'Contact Somerset Window Cleaning for your free quote. Call 01458 860339, WhatsApp, or book online. Covering Somerset with professional window cleaning services.',
};
---

<Layout metadata={metadata} structuredDataType="contact">
  <!-- HeroText Widget ******************* -->

  <!-- Coverage hero (hidden by default; shown via client script when covered=true) -->
  <div id="hero-covered" class="hidden">
    <HeroText tagline="Coverage confirmed" subtitle="Send your details below for a fast, firm quote (we'll reply within one working day).">
      <Fragment slot="bg">
        <img src={heroImage.src} alt="Professional window cleaning service - get in touch for a free quote" width="1600" height="900" style="width:100%; height:100%; object-fit:cover; opacity:0.55;" />
        <div class="absolute inset-0 bg-black/40"></div>
      </Fragment>
      <Fragment slot="title">Yes — we cover <span class="text-accent" id="covered-postcode"></span></Fragment>
      <div class="max-w-4xl mx-auto mt-4 flex flex-wrap justify-center gap-3">
        <a href="#form" class="btn-primary whitespace-nowrap animate-pulse">Start your quote</a>
        <a id="covered-whats" href="https://wa.me/447415526331?text=Hi%20Somerset%20Window%20Cleaning%2C%20I%27d%20like%20a%20quote" class="btn-whatsapp whitespace-nowrap">WhatsApp</a>
      </div>
    </HeroText>
  </div>

  <!-- Default hero (shown by default) -->
  <div id="hero-default">
    <HeroText tagline="Contact" title="Contact Us" subtitle="We usually respond within one working day.">
      <Fragment slot="bg">
        <img src={heroImage.src} alt="Professional window cleaning service - get in touch for a free quote" width="1600" height="900" style="width:100%; height:100%; object-fit:cover; opacity:0.55;" />
        <div class="absolute inset-0 bg-black/40"></div>
      </Fragment>
    </HeroText>
  </div>

  <!-- Maybe-help banner (hidden by default; shown if postcode present but not confirmed) -->
  <section id="maybe-banner" class="hidden max-w-7xl mx-auto px-4 sm:px-6 -mt-6 pb-4">
    <div class="rounded-2xl border border-green-600/30 bg-gradient-to-r from-green-600/15 to-primary/10 p-5 sm:p-6">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
        <div class="flex items-start gap-3">
          <div class="mt-0.5">
            <Icon name="tabler:circle-check" class="w-7 h-7 text-green-500" />
          </div>
          <div>
            <h3 class="text-xl font-semibold">
              We may still be able to help in <span class="text-accent" id="maybe-postcode"></span>
            </h3>
            <p class="text-sm text-muted mt-1">Reliable 4–8 week schedules with email or text reminders. Fully insured. 48‑hour guarantee.</p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <a href="#form" class="btn-primary whitespace-nowrap">Start your quote</a>
          <a id="maybe-whats" href="https://wa.me/447415526331?text=Hi%20Somerset%20Window%20Cleaning%2C%20I%27d%20like%20a%20quote" class="btn-whatsapp whitespace-nowrap">WhatsApp</a>
        </div>
      </div>
    </div>
  </section>


  <!-- Enhanced New Customer Section -->
  <section class="py-12 bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="max-w-6xl mx-auto px-4 sm:px-6">
      <!-- Main CTA Card -->
      <div class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-red-600 via-red-700 to-red-800 p-1 shadow-2xl">
        <div class="rounded-[calc(1.5rem-1px)] bg-white p-8 md:p-12">
          <div class="text-center">
            <!-- Icon and Badge -->
            <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mb-6">
              <Icon name="tabler:user-plus" class="w-8 h-8 text-red-600" />
            </div>
            
            <!-- Heading -->
            <h3 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">
              New Customer?
            </h3>
            
            <!-- Subheading -->
            <p class="text-xl text-gray-600 mb-8 max-w-3xl mx-auto leading-relaxed">
              Get <span class="font-semibold text-red-600">instant pricing</span> and book your first clean online in just <span class="font-semibold text-red-600">4 easy steps</span>!
            </p>
            
            <!-- Features Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-10">
              <div class="flex flex-col items-center p-4 bg-gray-50 rounded-xl">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mb-2">
                  <span class="text-red-600 font-bold">1</span>
                </div>
                <span class="text-sm font-medium text-gray-700">Property Details</span>
              </div>
              <div class="flex flex-col items-center p-4 bg-gray-50 rounded-xl">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mb-2">
                  <span class="text-red-600 font-bold">2</span>
                </div>
                <span class="text-sm font-medium text-gray-700">Choose Services</span>
              </div>
              <div class="flex flex-col items-center p-4 bg-gray-50 rounded-xl">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mb-2">
                  <span class="text-red-600 font-bold">3</span>
                </div>
                <span class="text-sm font-medium text-gray-700">Instant Quote</span>
              </div>
              <div class="flex flex-col items-center p-4 bg-gray-50 rounded-xl">
                <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mb-2">
                  <span class="text-red-600 font-bold">4</span>
                </div>
                <span class="text-sm font-medium text-gray-700">Book & Pay</span>
              </div>
            </div>
            
            <!-- CTA Button -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
              <a href="/book-now" class="group inline-flex items-center gap-3 px-10 py-5 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold text-lg rounded-2xl shadow-xl hover:shadow-2xl transform hover:-translate-y-1 transition-all duration-300">
                <Icon name="tabler:calendar-plus" class="w-6 h-6 group-hover:scale-110 transition-transform" />
                Book Online Now
                <Icon name="tabler:arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform" />
              </a>
              
              <!-- Secondary info -->
              <div class="flex items-center gap-2 text-sm text-gray-500">
                <Icon name="tabler:clock" class="w-4 h-4" />
                <span>Takes less than 3 minutes</span>
              </div>
            </div>
            
            <!-- Trust indicators -->
            <div class="flex justify-center items-center gap-6 mt-8 pt-8 border-t border-gray-200">
              <div class="flex items-center gap-2">
                <Icon name="tabler:shield-check" class="w-5 h-5 text-green-600" />
                <span class="text-sm text-gray-600">Fully Insured</span>
              </div>
              <div class="flex items-center gap-2">
                <Icon name="tabler:star-filled" class="w-5 h-5 text-yellow-500" />
                <span class="text-sm text-gray-600">4.9/5 Rating</span>
              </div>
              <div class="flex items-center gap-2">
                <Icon name="tabler:users" class="w-5 h-5 text-blue-600" />
                <span class="text-sm text-gray-600">4,000+ Customers</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Alternative contact methods -->
      <div class="mt-8 text-center">
        <p class="text-gray-600 mb-4">Prefer to speak to someone first?</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
          <a href="tel:01458860339" class="inline-flex items-center gap-2 px-6 py-3 border-2 border-red-600 text-red-600 hover:bg-red-600 hover:text-white font-semibold rounded-lg transition-colors duration-200">
            <Icon name="tabler:phone" class="w-5 h-5" />
            Call 01458 860339
          </a>
          <a href="https://wa.me/447415526331?text=Hi%20Somerset%20Window%20Cleaning%2C%20I%27d%20like%20a%20quote" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors duration-200">
            <Icon name="tabler:brand-whatsapp" class="w-5 h-5" />
            WhatsApp
          </a>
        </div>
      </div>
    </div>
  </section>

  <ContactUs
    id="form"
    title="Quick Contact Form"
    subtitle="For existing customers or general enquiries only"
    inputs={[
      { type: 'text', name: 'fullName', label: 'Full name', required: true },
      { type: 'email', name: 'email', label: 'Email address', required: true },
      { type: 'tel', name: 'phone', label: 'Phone number (optional)' },
      { type: 'select', name: 'customerType', label: 'Customer type', options: ['New Customer', 'Existing Customer'] },
      { type: 'file', name: 'photos', label: 'Photos (optional)', multiple: true, accept: 'image/*' },
    ]}
    textarea={{ label: 'Your message', required: true, rows: 4 }}
    disclaimer={{ label: 'We\'ll respond within one working day.' }}
    description=""
  >
    <Fragment slot="aside">
      <div class="space-y-5">
        <h3 class="text-lg font-semibold">Prefer to talk?</h3>
        <div class="grid grid-cols-1 gap-3">
          <a href="tel:01458860339" class="inline-flex items-center justify-center rounded-md bg-red-600 text-white px-4 py-2 hover:bg-red-700 font-medium">
            <Icon name="tabler:phone" class="w-4 h-4 mr-2 text-white" />
            <span class="text-white">Call 01458 860339</span>
          </a>
          <a href="mailto:info@somersetwindowcleaning.co.uk" class="inline-flex items-center justify-center rounded-md bg-gray-700 text-white px-4 py-2 hover:bg-gray-600 text-sm break-all">
            <Icon name="tabler:mail" class="w-4 h-4 mr-2 text-white" />
            <span class="text-white">Email us</span>
          </a>
          <a href="https://wa.me/447415526331?text=Hi%20Somerset%20Window%20Cleaning%2C%20I%27d%20like%20to%20discuss%20my%20requirements" class="inline-flex items-center justify-center rounded-md bg-green-600 text-white px-4 py-2 hover:bg-green-700">
            <Icon name="tabler:brand-whatsapp" class="w-4 h-4 mr-2 text-white" />
            <span class="text-white">WhatsApp</span>
          </a>
        </div>

        <div class="pt-3 border-t border-gray-700/40">
          <h4 class="text-base font-semibold mb-2">Business hours</h4>
          <p class="text-sm text-gray-300">Mon–Fri 9:00–16:00 · We usually reply within one working day.</p>
        </div>

      </div>
    </Fragment>
  </ContactUs>

  <!-- Features2 Widget ************** -->

  <script is:inline>
    const params = new URLSearchParams(window.location.search);
    const pc = (params.get('postcode') || '').toUpperCase();
    const coveredFlag = params.get('covered') === '1';
    if (pc) {
      const el = document.getElementById('postcode');
      if (el) el.value = pc.replace(/\s+/g, '');
    }
    const heroDefault = document.getElementById('hero-default');
    const heroCovered = document.getElementById('hero-covered');
    const coveredPcEl = document.getElementById('covered-postcode');
    const coveredWhats = document.getElementById('covered-whats');
    const maybeBanner = document.getElementById('maybe-banner');
    const maybePcEl = document.getElementById('maybe-postcode');
    const maybeWhats = document.getElementById('maybe-whats');

    const whatsUrl = 'https://wa.me/447415526331?text=' + encodeURIComponent('Hi Somerset Window Cleaning, my postcode is ' + pc + " and I'd like a quote");

    if (coveredFlag && pc) {
      if (heroDefault) heroDefault.classList.add('hidden');
      if (heroCovered) heroCovered.classList.remove('hidden');
      if (coveredPcEl) coveredPcEl.textContent = pc;
      if (coveredWhats) coveredWhats.href = whatsUrl;

      // Delay scroll to keep the confirmation hero visible for a moment
      const form = document.getElementById('form');
      let userInteracted = false;
      ['wheel','touchmove','keydown','scroll'].forEach((ev) => {
        window.addEventListener(ev, () => { userInteracted = true; }, { once: true, passive: true });
      });
      if (form) setTimeout(() => {
        if (!userInteracted) {
          try {
            const rect = form.getBoundingClientRect();
            const y = rect.top + window.scrollY - 120; // offset so the heading is fully visible below sticky header
            window.scrollTo({ top: y, behavior: 'smooth' });
          } catch {}
        }
      }, 2400);

      try {
        const confettiHost = document.createElement('div');
        confettiHost.id = 'confetti';
        document.body.appendChild(confettiHost);
        const colors = ['#22c55e', '#ef4444', '#ffffff', '#f59e0b'];
        for (let i = 0; i < 48; i++) {
          const s = document.createElement('span');
          s.className = 'confetti';
          s.style.left = Math.random() * 100 + '%';
          s.style.background = colors[Math.floor(Math.random() * colors.length)];
          s.style.animationDelay = (Math.random() * 0.6) + 's';
          s.style.transform = 'translateY(-10px) rotate(' + Math.floor(Math.random() * 360) + 'deg)';
          confettiHost.appendChild(s);
        }
        setTimeout(() => { confettiHost.remove(); }, 2000);
      } catch {}
    } else if (pc) {
      if (maybeBanner) maybeBanner.classList.remove('hidden');
      if (maybePcEl) maybePcEl.textContent = pc;
      if (maybeWhats) maybeWhats.href = whatsUrl;
    }

  </script>

  <style is:inline>
    #confetti { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 60; }
    .confetti { position: absolute; width: 8px; height: 14px; opacity: .9; border-radius: 2px; animation: confetti-fall 1200ms ease-out forwards; }
    @keyframes confetti-fall { from { transform: translateY(-10px) rotate(0deg); } to { transform: translateY(110vh) rotate(360deg); } }
  </style>
  
</Layout>
